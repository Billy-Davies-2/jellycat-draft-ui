{{ define "content" }}
<div class="min-h-screen" hx-ext="sse" sse-connect="/api/events" sse-swap="sse-event" hx-trigger="sse-event from:body" hx-get="/api/draft/state" hx-target="#draft-content" hx-swap="none"
     x-data="draftApp()" x-init="init()">
    <!-- Header -->
    <div class="bg-white border-b-2 border-pink-200 shadow-sm">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-3xl">ðŸ§¸</div>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-pink-500 to-purple-600 bg-clip-text text-transparent">
                        Jellycat Fantasy Draft
                    </h1>
                </div>
                <div class="flex items-center gap-6">
                    <!-- Alpine.js: Filter controls -->
                    <div class="flex items-center gap-2">
                        <input type="text" x-model="search" @input="filterPlayers" 
                               placeholder="Search Jellycats..." 
                               class="px-3 py-1 text-sm border-2 border-pink-200 rounded-lg focus:border-pink-400 focus:outline-none">
                        <select x-model="filterPosition" @change="filterPlayers"
                                class="px-3 py-1 text-sm border-2 border-pink-200 rounded-lg focus:border-pink-400 focus:outline-none">
                            <option value="">All Positions</option>
                            <option value="CC">CC - Cuddle Companion</option>
                            <option value="SS">SS - Snuggle Specialist</option>
                            <option value="HH">HH - Hug Hero</option>
                            <option value="DD">DD - Dream Defender</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-semibold" id="pick-counter">Draft in Progress</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="draft-content" class="container mx-auto px-4 py-6">
        <!-- Tabs -->
        <div class="mb-6">
            <div class="flex border-2 border-pink-200 rounded-lg overflow-hidden bg-white">
                <button onclick="showTab('draft')" id="tab-draft" class="flex-1 px-4 py-3 font-semibold bg-pink-100 border-r border-pink-200">
                    <span class="inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Draft Board
                    </span>
                </button>
                <button onclick="showTab('teams')" id="tab-teams" class="flex-1 px-4 py-3 font-semibold border-r border-pink-200 hover:bg-purple-50">
                    <span class="inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                        Team Rosters
                    </span>
                </button>
                <button onclick="showTab('chat')" id="tab-chat" class="flex-1 px-4 py-3 font-semibold hover:bg-blue-50">
                    <span class="inline-flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        Live Chat
                    </span>
                </button>
            </div>
        </div>

        <!-- Draft Tab Content -->
        <div id="content-draft" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                <div class="lg:col-span-3">
                    <div class="border-2 border-pink-200 rounded-lg bg-white">
                        <div class="bg-gradient-to-r from-pink-100 to-purple-100 p-4 rounded-t-lg">
                            <h3 class="font-bold text-lg flex items-center gap-2">
                                <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                Available Jellycats (<span id="available-count"></span>)
                            </h3>
                        </div>
                        <div class="p-4">
                            <div id="players-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                                {{ range .Players }}
                                {{ if not .Drafted }}
                                <div class="border-2 border-gray-200 rounded-lg p-4 hover:border-pink-300 hover:shadow-lg transition cursor-pointer"
                                     onclick="selectPlayer('{{ .ID }}', '{{ .Name }}', '{{ .Image }}', '{{ .Team }}', '{{ .Position }}', {{ .Points }})">
                                    <div class="flex flex-col items-center gap-3 mb-3">
                                        <img src="{{ .Image }}" alt="{{ .Name }}" 
                                             class="w-20 h-20 rounded-xl object-cover border-2 border-pink-200 shadow-sm"
                                             onerror="this.src='/static/images/placeholder.png'">
                                        <div class="text-center">
                                            <div class="font-semibold text-sm">{{ .Name }}</div>
                                            <div class="text-xs text-gray-600">{{ .Team }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between mb-2">
                                        <span class="px-2 py-1 rounded text-xs font-medium border 
                                            {{ if eq .Position "CC" }}bg-pink-100 text-pink-700 border-pink-200
                                            {{ else if eq .Position "SS" }}bg-purple-100 text-purple-700 border-purple-200
                                            {{ else if eq .Position "HH" }}bg-blue-100 text-blue-700 border-blue-200
                                            {{ else }}bg-green-100 text-green-700 border-green-200{{ end }}">
                                            {{ .Position }}
                                        </span>
                                        <span class="px-2 py-1 rounded text-xs font-medium
                                            {{ if eq .Tier "S" }}bg-gradient-to-r from-yellow-200 to-yellow-300 text-yellow-800
                                            {{ else if eq .Tier "A" }}bg-gradient-to-r from-green-200 to-green-300 text-green-800
                                            {{ else if eq .Tier "B" }}bg-gradient-to-r from-blue-200 to-blue-300 text-blue-800
                                            {{ else }}bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800{{ end }}">
                                            Tier {{ .Tier }}
                                        </span>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-lg font-bold text-purple-600">{{ .Points }}</div>
                                        <div class="text-xs text-gray-500">Cuddle Points</div>
                                    </div>
                                </div>
                                {{ end }}
                                {{ end }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="border-2 border-purple-200 rounded-lg bg-white sticky top-4">
                        <div class="bg-gradient-to-r from-purple-100 to-pink-100 p-4 rounded-t-lg">
                            <h3 class="font-bold text-lg flex items-center gap-2">
                                <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                                Draft Controls
                            </h3>
                        </div>
                        <div id="draft-sidebar" class="p-4">
                            <div class="text-center text-gray-500 py-8">
                                <div class="text-4xl mb-2">ðŸ§¸</div>
                                <div>Select a Jellycat to draft</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teams Tab Content -->
        <div id="content-teams" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {{ range .Teams }}
                <div class="border-2 rounded-lg {{ .Color }} bg-white">
                    <div class="{{ .Color }} p-4 rounded-t-lg">
                        <h3 class="font-bold text-lg flex items-center gap-3">
                            <span class="text-2xl">{{ .Mascot }}</span>
                            <div>
                                <div>{{ .Name }}</div>
                                <div class="text-sm font-normal text-gray-600">Owner: {{ .Owner }}</div>
                            </div>
                        </h3>
                    </div>
                    <div class="p-4">
                        {{ if .Players }}
                        <div class="space-y-3">
                            {{ range .Players }}
                            <div class="flex items-center gap-3 p-2 bg-white rounded-lg border">
                                <img src="{{ .Image }}" alt="{{ .Name }}" 
                                     class="w-10 h-10 rounded-lg object-cover border border-pink-200"
                                     onerror="this.src='/static/images/placeholder.png'">
                                <div class="flex-1">
                                    <div class="font-semibold text-sm">{{ .Name }}</div>
                                    <div class="text-xs text-gray-600">{{ .Team }} â€¢ {{ .Position }}</div>
                                </div>
                                <div class="text-sm font-semibold text-purple-600">{{ .Points }}</div>
                            </div>
                            {{ end }}
                        </div>
                        {{ else }}
                        <div class="text-center text-gray-500 py-8">
                            <div class="text-3xl mb-2">ðŸ’¤</div>
                            <div class="text-sm">No Jellycats drafted yet</div>
                        </div>
                        {{ end }}
                    </div>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Chat Tab Content -->
        <div id="content-chat" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="border-2 border-blue-200 rounded-lg bg-white">
                        <div class="bg-blue-50 p-4 rounded-t-lg">
                            <h3 class="font-bold text-lg">Live Chat & Reactions</h3>
                        </div>
                        <div id="chat-messages" class="p-4 space-y-3 max-h-96 overflow-y-auto">
                            {{ range .Chat }}
                            <div class="p-3 rounded-lg bg-white border">
                                <div class="text-sm mb-1">
                                    <span class="{{ if eq .Type "system" }}text-purple-700 font-semibold{{ else }}text-gray-800{{ end }}">
                                        {{ if eq .Type "system" }}System{{ else }}User{{ end }}
                                    </span>
                                    <span class="text-gray-500 text-xs ml-2">
                                        {{ .TS }}
                                    </span>
                                </div>
                                <div>{{ .Text }}</div>
                                <div class="mt-2 flex gap-2 flex-wrap">
                                    {{ range $emote, $count := .Emotes }}
                                    <button class="px-2 py-1 border rounded bg-white hover:bg-gray-50 text-sm"
                                            hx-post="/api/chat/react" 
                                            hx-vals='{"messageId": "{{ $.ID }}", "emote": "{{ $emote }}", "user": ""}'
                                            hx-swap="none">
                                        <span class="mr-1">{{ $emote }}</span>
                                        <span class="text-xs text-gray-600">{{ $count }}</span>
                                    </button>
                                    {{ end }}
                                </div>
                            </div>
                            {{ end }}
                        </div>
                    </div>
                </div>
                <div>
                    <div class="border-2 border-blue-200 rounded-lg bg-white sticky top-4">
                        <div class="bg-blue-50 p-4 rounded-t-lg">
                            <h3 class="font-bold text-lg">Send a message</h3>
                        </div>
                        <div class="p-4">
                            <form hx-post="/api/chat/send" hx-swap="none" onsubmit="this.reset()">
                                <div class="flex gap-2">
                                    <input type="text" name="text" placeholder="Cheer on picksâ€¦" required
                                           class="flex-1 border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                                        Send
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let selectedPlayer = null;
let currentTeamIndex = 0;
const teams = {{ len .Teams }};

function showTab(tab) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    // Show selected tab content
    document.getElementById('content-' + tab).classList.remove('hidden');
    
    // Update tab buttons
    document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('bg-pink-100', 'bg-purple-100', 'bg-blue-100');
        el.classList.add('hover:bg-purple-50');
    });
    
    const activeTab = document.getElementById('tab-' + tab);
    activeTab.classList.remove('hover:bg-purple-50');
    if (tab === 'draft') activeTab.classList.add('bg-pink-100');
    if (tab === 'teams') activeTab.classList.add('bg-purple-100');
    if (tab === 'chat') activeTab.classList.add('bg-blue-100');
}

function selectPlayer(id, name, image, team, position, points) {
    selectedPlayer = { id, name, image, team, position, points };
    
    const sidebar = document.getElementById('draft-sidebar');
    sidebar.innerHTML = `
        <div class="space-y-4">
            <div class="text-center">
                <img src="${image}" alt="${name}" 
                     class="w-24 h-24 mx-auto mb-3 rounded-xl object-cover border-2 border-pink-200 shadow-sm"
                     onerror="this.src='/static/images/placeholder.png'">
                <div class="font-semibold">${name}</div>
                <div class="text-sm text-gray-600">${team} â€¢ ${position}</div>
            </div>
            <div class="text-center">
                <div class="text-2xl font-bold text-purple-600">${points}</div>
                <div class="text-sm text-gray-500">Cuddle Points</div>
            </div>
            <button onclick="draftPlayer()" 
                    class="w-full bg-gradient-to-r from-pink-500 to-purple-600 hover:from-pink-600 hover:to-purple-700 text-white font-semibold py-2 rounded-full">
                Draft Jellycat
            </button>
        </div>
    `;
}

function draftPlayer() {
    if (!selectedPlayer) return;
    
    // Use hardcoded teams from template data
    const teams = [{{ range $i, $t := .Teams }}{{ if $i }},{{ end }}"{{ $t.ID }}"{{ end }}];
    if (teams.length > 0) {
        submitDraft(teams[currentTeamIndex % teams.length]);
    }
}

function submitDraft(teamId) {
    fetch('/api/draft/pick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            playerId: selectedPlayer.id,
            teamId: teamId
        })
    }).then(response => {
        if (response.ok) {
            selectedPlayer = null;
            currentTeamIndex++;
            // SSE will trigger automatic refresh via htmx
            // No manual reload needed
        }
    });
}

// Update available count
function updateAvailableCount() {
    const count = document.querySelectorAll('#players-grid > div').length;
    const counter = document.getElementById('available-count');
    if (counter) counter.textContent = count;
}

document.addEventListener('DOMContentLoaded', updateAvailableCount);

// Alpine.js: Draft app component with reactive state
function draftApp() {
    return {
        search: '',
        filterPosition: '',
        filterTier: '',
        notification: null,
        
        init() {
            // Listen for SSE events and show notifications
            document.addEventListener('htmx:afterSwap', () => {
                this.showNotification('Draft updated!', 'success');
            });
        },
        
        filterPlayers() {
            const players = document.querySelectorAll('#players-grid > div');
            let visibleCount = 0;
            
            players.forEach(player => {
                const playerCard = player;
                const name = playerCard.textContent.toLowerCase();
                const matchesSearch = this.search === '' || name.includes(this.search.toLowerCase());
                
                // Get position from the player card
                const positionEl = playerCard.querySelector('.px-2.py-1.rounded.text-xs.font-medium.border');
                const position = positionEl ? positionEl.textContent.trim() : '';
                const matchesPosition = this.filterPosition === '' || position === this.filterPosition;
                
                if (matchesSearch && matchesPosition) {
                    playerCard.style.display = '';
                    visibleCount++;
                } else {
                    playerCard.style.display = 'none';
                }
            });
            
            // Update counter
            const counter = document.getElementById('available-count');
            if (counter) {
                counter.textContent = visibleCount;
            }
        },
        
        showNotification(message, type = 'info') {
            this.notification = { message, type };
            setTimeout(() => {
                this.notification = null;
            }, 3000);
        },
        
        resetFilters() {
            this.search = '';
            this.filterPosition = '';
            this.filterTier = '';
            this.filterPlayers();
        }
    };
}
</script>

<!-- Alpine.js: Notification component -->
<div x-data="draftApp()" x-show="notification" x-transition
     class="fixed top-4 right-4 z-50 max-w-sm"
     style="display: none;">
    <div :class="{
        'bg-green-100 border-green-400 text-green-700': notification && notification.type === 'success',
        'bg-blue-100 border-blue-400 text-blue-700': notification && notification.type === 'info',
        'bg-red-100 border-red-400 text-red-700': notification && notification.type === 'error'
    }" 
    class="border px-4 py-3 rounded-lg shadow-lg">
        <p x-text="notification ? notification.message : ''"></p>
    </div>
</div>

</script>
{{ end }}
