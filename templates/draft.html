{{ define "content" }}
<div class="min-h-screen relative"
     x-data="draftApp()" x-init="init()">
    <!-- Decorative background elements -->
    <div class="absolute top-20 right-20 text-6xl opacity-10 animate-float">üèà</div>
    <div class="absolute bottom-40 left-10 text-5xl opacity-10 animate-bounce-slow">üß∏</div>
    
    <!-- Header -->
    <div class="bg-white/90 backdrop-blur-sm border-b-2 border-pink-200 shadow-soft sticky top-0 z-40">
        <div class="container mx-auto px-4 py-5">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <div class="text-4xl animate-bounce-slow">üß∏</div>
                    <h1 class="text-3xl font-display font-bold text-gradient-jellycat">
                        Jellycat Fantasy Draft
                    </h1>
                    <div class="text-3xl animate-float">üèà</div>
                </div>
                <div class="flex items-center gap-6">
                    <!-- Alpine.js: Filter controls -->
                    <div class="flex items-center gap-3">
                        <input type="text" x-model="search" @input="filterPlayers" 
                               placeholder="Search Jellycats..." 
                               class="input-jellycat px-4 py-2 text-sm w-48">
                        <select x-model="filterPosition" @change="filterPlayers"
                                class="input-jellycat px-4 py-2 text-sm">
                            <option value="">All Positions</option>
                            <option value="CC">CC - Cuddle Companion</option>
                            <option value="SS">SS - Snuggle Specialist</option>
                            <option value="HH">HH - Hug Hero</option>
                            <option value="DD">DD - Dream Defender</option>
                        </select>
                    </div>
                    <div class="flex items-center gap-2 px-4 py-2 rounded-full bg-gradient-to-r from-pink-100 to-purple-100 shadow-soft">
                        <svg class="w-5 h-5 text-pink-600 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span class="font-semibold text-gray-700 font-display" id="pick-counter">
                            {{ if .CurrentTeamName }}
                                Pick {{ .CurrentPick }}: {{ .CurrentTeamName }}'s turn üèà
                            {{ else }}
                                Draft in Progress
                            {{ end }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="draft-content" class="container mx-auto px-4 py-8">
        <!-- Tabs -->
        <div class="mb-8">
            <div class="flex border-2 border-pink-200 rounded-2xl overflow-hidden bg-white shadow-soft">
                <button onclick="showTab('draft')" id="tab-draft" class="tab-jellycat active flex-1 px-6 py-4">
                    <span class="inline-flex items-center gap-2 font-display font-semibold text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        Draft Board
                    </span>
                </button>
                <button onclick="showTab('teams')" id="tab-teams" class="tab-jellycat flex-1 px-6 py-4 border-l-2 border-pink-200">
                    <span class="inline-flex items-center gap-2 font-display font-semibold text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                        Team Rosters
                    </span>
                </button>
                <button onclick="showTab('chat')" id="tab-chat" class="tab-jellycat flex-1 px-6 py-4 border-l-2 border-pink-200">
                    <span class="inline-flex items-center gap-2 font-display font-semibold text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                        Live Chat
                    </span>
                </button>
            </div>
        </div>

        <!-- Draft Tab Content -->
        <div id="content-draft" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <div class="lg:col-span-3">
                    <div class="card-jellycat shadow-soft-lg">
                        <div class="bg-gradient-to-r from-pink-100 via-purple-100 to-blue-100 p-5 rounded-t-2xl">
                            <h3 class="font-display font-bold text-xl flex items-center gap-3">
                                <svg class="w-6 h-6 text-yellow-500 animate-pulse-soft" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>
                                <span class="text-gradient-jellycat">Available Jellycats (<span id="available-count"></span>)</span>
                            </h3>
                        </div>
                        <div class="p-5">
                            <div id="players-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
                                {{ range .Players }}
                                {{ if not .Drafted }}
                                <div class="player-card"
                                     data-player-id="{{ .ID }}"
                                     onclick="selectPlayer('{{ .ID }}', '{{ .Name }}', '{{ .Image }}', '{{ .Team }}', '{{ .Position }}', {{ .Points }})">
                                    <div class="flex flex-col items-center gap-3 mb-3">
                                        <img src="{{ .Image }}" alt="{{ .Name }}" 
                                             class="w-24 h-24 rounded-2xl object-cover border-3 border-pink-200 shadow-soft"
                                             onerror="this.src='/static/images/placeholder.png'">
                                        <div class="text-center">
                                            <div class="font-bold text-base font-display text-gray-800">{{ .Name }}</div>
                                            <div class="text-xs text-gray-600 mt-1">{{ .Team }}</div>
                                        </div>
                                    </div>
                                    <div class="flex items-center justify-between mb-3">
                                        <span class="px-3 py-1.5 rounded-full text-xs font-semibold border-2 
                                            {{ if eq .Position "CC" }}bg-pink-100 text-pink-700 border-pink-300
                                            {{ else if eq .Position "SS" }}bg-purple-100 text-purple-700 border-purple-300
                                            {{ else if eq .Position "HH" }}bg-blue-100 text-blue-700 border-blue-300
                                            {{ else }}bg-green-100 text-green-700 border-green-300{{ end }}">
                                            {{ .Position }}
                                        </span>
                                        <span class="px-3 py-1.5 rounded-full text-xs font-bold
                                            {{ if eq .Tier "S" }}bg-gradient-to-r from-yellow-200 to-yellow-300 text-yellow-900
                                            {{ else if eq .Tier "A" }}bg-gradient-to-r from-green-200 to-green-300 text-green-900
                                            {{ else if eq .Tier "B" }}bg-gradient-to-r from-blue-200 to-blue-300 text-blue-900
                                            {{ else }}bg-gradient-to-r from-gray-200 to-gray-300 text-gray-800{{ end }}">
                                            Tier {{ .Tier }}
                                        </span>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-gradient-jellycat">{{ .Points }}</div>
                                        <div class="text-xs text-gray-500 font-display">Cuddle Points üß∏</div>
                                    </div>
                                </div>
                                {{ end }}
                                {{ end }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="lg:col-span-1">
                    <div class="card-jellycat shadow-soft-lg sticky top-24">
                        <div class="bg-gradient-to-r from-purple-100 via-pink-100 to-purple-100 p-5 rounded-t-2xl">
                            <h3 class="font-display font-bold text-xl flex items-center gap-3">
                                <svg class="w-6 h-6 text-red-500 animate-pulse" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>
                                <span class="text-gradient-jellycat">Draft Controls</span>
                            </h3>
                        </div>
                        <div id="draft-sidebar" class="p-5">
                            <div class="text-center text-gray-500 py-10">
                                <div class="text-5xl mb-3 animate-float-slow">üß∏</div>
                                <div class="font-display text-gray-600">Select a Jellycat to draft</div>
                                <div class="mt-2 text-sm">‚öΩ Choose wisely! ‚öΩ</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Teams Tab Content -->
        <div id="content-teams" class="tab-content hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {{ range .Teams }}
                <div class="card-jellycat {{ .Color }} shadow-soft-lg hover:scale-105 transition-all duration-300">
                    <div class="{{ .Color }} p-5 rounded-t-2xl bg-gradient-to-br from-white/50 to-transparent">
                        <h3 class="font-display font-bold text-xl flex items-center gap-3">
                            <span class="text-3xl animate-bounce-slow">{{ .Mascot }}</span>
                            <div>
                                <div class="text-gray-800">{{ .Name }}</div>
                                <div class="text-sm font-normal text-gray-600 mt-1">Owner: {{ .Owner }}</div>
                            </div>
                        </h3>
                    </div>
                    <div class="p-5">
                        {{ if .Players }}
                        <div class="space-y-3">
                            {{ range .Players }}
                            <div class="flex items-center gap-3 p-3 bg-white rounded-xl border-2 border-pink-200 shadow-soft hover:shadow-soft-lg transition-all duration-200">
                                <img src="{{ .Image }}" alt="{{ .Name }}" 
                                     class="w-12 h-12 rounded-xl object-cover border-2 border-pink-200"
                                     onerror="this.src='/static/images/placeholder.png'">
                                <div class="flex-1">
                                    <div class="font-semibold text-sm font-display text-gray-800">{{ .Name }}</div>
                                    <div class="text-xs text-gray-600">{{ .Team }} ‚Ä¢ {{ .Position }}</div>
                                </div>
                                <div class="cuddle-badge">{{ .Points }}</div>
                            </div>
                            {{ end }}
                        </div>
                        {{ else }}
                        <div class="text-center text-gray-500 py-10">
                            <div class="text-4xl mb-3 animate-pulse-soft">üí§</div>
                            <div class="text-sm font-display">No Jellycats drafted yet</div>
                            <div class="text-xs mt-1">‚öΩ Start your cuddly team! ‚öΩ</div>
                        </div>
                        {{ end }}
                    </div>
                </div>
                {{ end }}
            </div>
        </div>

        <!-- Chat Tab Content -->
        <div id="content-chat" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div class="card-jellycat shadow-soft-lg">
                        <div class="bg-gradient-to-r from-blue-100 via-purple-100 to-pink-100 p-5 rounded-t-2xl">
                            <h3 class="font-display font-bold text-xl text-gradient-jellycat">üí¨ Live Chat & Reactions</h3>
                        </div>
                        <div id="chat-messages" class="p-5 space-y-3 max-h-96 overflow-y-auto">
                            {{ range .Chat }}
                            <div data-message-id="{{ .ID }}" class="p-4 rounded-2xl bg-gradient-to-br from-white to-pink-50 border-2 border-pink-200 shadow-soft hover:shadow-soft-lg transition-all duration-200">
                                <div class="text-sm mb-2">
                                    <span class="{{ if eq .Type "system" }}text-purple-700 font-bold font-display{{ else }}text-gray-800 font-semibold{{ end }}">
                                        {{ if eq .Type "system" }}ü§ñ System{{ else }}üë§ User{{ end }}
                                    </span>
                                    <span class="text-gray-500 text-xs ml-2">
                                        {{ .TS }}
                                    </span>
                                </div>
                                <div class="text-gray-800 font-display">{{ .Text }}</div>
                                <div class="mt-3 flex gap-2 flex-wrap">
                                    {{ range $emote, $count := .Emotes }}
                                    <button class="px-3 py-1.5 border-2 border-pink-200 rounded-full bg-white hover:bg-pink-50 text-sm transition-all duration-200 hover:scale-110"
                                            hx-post="/api/chat/react" 
                                            hx-vals='{"messageId": "{{ $.ID }}", "emote": "{{ $emote }}", "user": ""}'
                                            hx-swap="none">
                                        <span class="mr-1">{{ $emote }}</span>
                                        <span class="text-xs text-gray-600 font-semibold">{{ $count }}</span>
                                    </button>
                                    {{ end }}
                                </div>
                            </div>
                            {{ end }}
                        </div>
                    </div>
                </div>
                <div>
                    <div class="card-jellycat shadow-soft-lg sticky top-24">
                        <div class="bg-gradient-to-r from-blue-100 to-purple-100 p-5 rounded-t-2xl">
                            <h3 class="font-display font-bold text-xl text-gradient-jellycat">‚úâÔ∏è Send a message</h3>
                        </div>
                        <div class="p-5">
                            <form hx-post="/api/chat/send" hx-swap="none" onsubmit="this.reset()">
                                <div class="flex flex-col gap-3">
                                    <input type="text" name="text" placeholder="Cheer on picks‚Ä¶ üéâ" required
                                           class="input-jellycat">
                                    <button type="submit" class="btn-jellycat text-base">
                                        üì® Send Message
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Alpine.js: Notification component (inside main component scope) -->
    <div x-show="notification" x-transition
         class="fixed top-4 right-4 z-50 max-w-sm"
         style="display: none;">
        <div :class="{
            'bg-green-100 border-green-400 text-green-700': notification && notification.type === 'success',
            'bg-blue-100 border-blue-400 text-blue-700': notification && notification.type === 'info',
            'bg-red-100 border-red-400 text-red-700': notification && notification.type === 'error'
        }" 
        class="border px-4 py-3 rounded-lg shadow-lg">
            <p x-text="notification ? notification.message : ''"></p>
        </div>
    </div>
</div>

<script>
let selectedPlayer = null;
let currentTeamIndex = 0;
const teams = {{ len .Teams }};

function showTab(tab) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
    // Show selected tab content
    document.getElementById('content-' + tab).classList.remove('hidden');
    
    // Update tab buttons - remove all active classes
    document.querySelectorAll('[id^="tab-"]').forEach(el => {
        el.classList.remove('active');
    });
    
    // Add active class to selected tab
    const activeTab = document.getElementById('tab-' + tab);
    activeTab.classList.add('active');
}

function selectPlayer(id, name, image, team, position, points) {
    selectedPlayer = { id, name, image, team, position, points };
    
    const sidebar = document.getElementById('draft-sidebar');
    sidebar.innerHTML = `
        <div class="space-y-5">
            <div class="text-center">
                <img src="${image}" alt="${name}" 
                     class="w-32 h-32 mx-auto mb-4 rounded-2xl object-cover border-3 border-pink-300 shadow-soft-lg"
                     onerror="this.src='/static/images/placeholder.png'">
                <div class="font-bold text-lg font-display text-gray-800">${name}</div>
                <div class="text-sm text-gray-600 mt-1">${team} ‚Ä¢ ${position}</div>
            </div>
            <div class="text-center p-4 bg-gradient-to-br from-pink-50 to-purple-50 rounded-2xl">
                <div class="text-3xl font-bold text-gradient-jellycat">${points}</div>
                <div class="text-sm text-gray-600 font-display mt-1">Cuddle Points üß∏</div>
            </div>
            <button onclick="draftPlayer()" 
                    class="btn-jellycat w-full text-base shadow-soft-lg">
                üèÜ Draft Jellycat üèÜ
            </button>
        </div>
    `;
}

function draftPlayer() {
    if (!selectedPlayer) return;
    
    // In interactive mode, use the current team's turn
    const currentTeamID = "{{ .CurrentTeamID }}";
    const userTeamID = "{{ .UserTeamID }}";
    
    // Use the current team's turn if available, otherwise fall back to round-robin
    let teamID = currentTeamID;
    if (!teamID) {
        const teams = [{{ range $i, $t := .Teams }}{{ if $i }},{{ end }}"{{ $t.ID }}"{{ end }}];
        teamID = teams[currentTeamIndex % teams.length];
    }
    
    if (teamID) {
        submitDraft(teamID);
    }
}

function submitDraft(teamId) {
    fetch('/api/draft/pick', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            playerId: selectedPlayer.id,
            teamId: teamId
        })
    }).then(response => {
        if (response.ok) {
            selectedPlayer = null;
            currentTeamIndex++;
            // SSE will trigger automatic refresh via htmx
            // No manual reload needed
        }
    });
}

// Update available count
function updateAvailableCount() {
    const count = document.querySelectorAll('#players-grid > div').length;
    const counter = document.getElementById('available-count');
    if (counter) counter.textContent = count;
}

document.addEventListener('DOMContentLoaded', updateAvailableCount);

// Alpine.js: Draft app component with reactive state
function draftApp() {
    return {
        search: '',
        filterPosition: '',
        filterTier: '',
        notification: null,
        
        init() {
            // Listen for SSE events and update UI dynamically
            const eventSource = new EventSource('/api/events');
            const initialIsUserTurn = {{ .IsUserTurn }};
            const initialTeamName = "{{ .CurrentTeamName }}";
            const initialPick = {{ .CurrentPick }};
            
            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'draft:pick') {
                        // Remove the drafted player from the UI immediately
                        const playerId = data.payload?.playerId;
                        if (playerId) {
                            const playerCard = document.querySelector(`[data-player-id="${playerId}"]`);
                            if (playerCard) {
                                // Animate removal
                                playerCard.style.transition = 'all 0.3s ease-out';
                                playerCard.style.opacity = '0';
                                playerCard.style.transform = 'scale(0.8)';
                                setTimeout(() => {
                                    playerCard.remove();
                                    this.updateAvailableCount();
                                    // Clear sidebar if this was the selected player
                                    if (selectedPlayer && selectedPlayer.id === playerId) {
                                        this.clearDraftSidebar();
                                    }
                                }, 300);
                            }
                        }
                        
                        // Fetch the full updated state to refresh team rosters and pick counter
                        this.refreshDraftState();
                        this.showNotification('Player drafted! üéâ', 'success');
                    } else if (data.type === 'chat:add') {
                        // Fetch and append the latest chat message
                        this.appendLatestChatMessage();
                    } else if (data.type === 'draft:reset') {
                        this.showNotification('Draft reset!', 'info');
                        setTimeout(() => {
                            window.location.reload();
                        }, 800);
                    }
                } catch (e) {
                    // Ignore parse errors for keepalive messages
                }
            };
            
            // Initialize available player count
            this.updateAvailableCount();
            
            // Show turn notification on page load (in development mode)
            if (initialTeamName) {
                setTimeout(() => {
                    if (initialIsUserTurn) {
                        this.showNotification("üèà It's YOUR turn to pick! Pick " + initialPick, 'success');
                    } else {
                        this.showNotification("üèà Current turn: " + initialTeamName + " (Pick " + initialPick + ")", 'info');
                    }
                }, 500);
            }
        },
        
        async refreshDraftState() {
            try {
                const response = await fetch('/api/draft/state');
                if (!response.ok) {
                    console.error('Failed to fetch draft state:', response.status, response.statusText);
                    this.showNotification('Failed to refresh draft state', 'error');
                    return;
                }
                const state = await response.json();
                
                // Update pick counter
                this.updatePickCounter(state);
                
                // Update team rosters
                this.updateTeamRosters(state.teams);
            } catch (e) {
                console.error('Failed to refresh draft state:', e);
                this.showNotification('Failed to refresh draft state', 'error');
            }
        },
        
        updatePickCounter(state) {
            const counter = document.getElementById('pick-counter');
            if (!counter) return;
            
            if (state.currentTeamName) {
                counter.innerHTML = `Pick ${state.currentPick}: ${this.escapeHtml(state.currentTeamName)}'s turn üèà`;
            } else {
                counter.innerHTML = 'Draft Complete! üéâ';
            }
        },
        
        updateTeamRosters(teams) {
            const teamsContainer = document.getElementById('content-teams');
            if (!teamsContainer || !teams) return;
            
            // Regenerate the entire teams grid for consistency
            const teamsGrid = teamsContainer.querySelector('.grid');
            if (!teamsGrid) return;
            
            teamsGrid.innerHTML = teams.map(team => this.createTeamCard(team)).join('');
        },
        
        createTeamCard(team) {
            // Guard clause: validate team parameter
            if (!team) {
                console.error('createTeamCard called with invalid team');
                return '';
            }
            
            const playersHtml = team.players && team.players.length > 0
                ? `<div class="space-y-3">
                    ${team.players.map(p => `
                        <div class="flex items-center gap-3 p-3 bg-white rounded-xl border-2 border-pink-200 shadow-soft hover:shadow-soft-lg transition-all duration-200">
                            <img src="${this.escapeHtml(p.image || '')}" alt="${this.escapeHtml(p.name || '')}" 
                                 class="w-12 h-12 rounded-xl object-cover border-2 border-pink-200"
                                 onerror="this.src='/static/images/placeholder.png'">
                            <div class="flex-1">
                                <div class="font-semibold text-sm font-display text-gray-800">${this.escapeHtml(p.name || '')}</div>
                                <div class="text-xs text-gray-600">${this.escapeHtml(p.team || '')} ‚Ä¢ ${this.escapeHtml(p.position || '')}</div>
                            </div>
                            <div class="cuddle-badge">${p.points || 0}</div>
                        </div>
                    `).join('')}
                   </div>`
                : `<div class="text-center text-gray-500 py-10">
                       <div class="text-4xl mb-3 animate-pulse-soft">üí§</div>
                       <div class="text-sm font-display">No Jellycats drafted yet</div>
                       <div class="text-xs mt-1">‚öΩ Start your cuddly team! ‚öΩ</div>
                   </div>`;
            
            return `
                <div class="card-jellycat ${this.escapeHtml(team.color || '')} shadow-soft-lg hover:scale-105 transition-all duration-300">
                    <div class="${this.escapeHtml(team.color || '')} p-5 rounded-t-2xl bg-gradient-to-br from-white/50 to-transparent">
                        <h3 class="font-display font-bold text-xl flex items-center gap-3">
                            <span class="text-3xl animate-bounce-slow">${this.escapeHtml(team.mascot || '')}</span>
                            <div>
                                <div class="text-gray-800">${this.escapeHtml(team.name || '')}</div>
                                <div class="text-sm font-normal text-gray-600 mt-1">Owner: ${this.escapeHtml(team.owner || '')}</div>
                            </div>
                        </h3>
                    </div>
                    <div class="p-5">
                        ${playersHtml}
                    </div>
                </div>
            `;
        },
        
        updateAvailableCount() {
            const players = document.querySelectorAll('#players-grid > div');
            const counter = document.getElementById('available-count');
            if (counter) {
                counter.textContent = players.length;
            }
        },
        
        clearDraftSidebar() {
            const sidebar = document.getElementById('draft-sidebar');
            if (sidebar) {
                sidebar.innerHTML = `
                    <div class="text-center text-gray-500 py-10">
                        <div class="text-5xl mb-3 animate-float-slow">üß∏</div>
                        <div class="font-display text-gray-600">Select a Jellycat to draft</div>
                        <div class="mt-2 text-sm">‚öΩ Choose wisely! ‚öΩ</div>
                    </div>
                `;
            }
            selectedPlayer = null;
        },
        
        async appendLatestChatMessage() {
            try {
                const response = await fetch('/api/chat/list');
                if (!response.ok) return;
                const messages = await response.json();
                if (!messages || messages.length === 0) return;
                
                // Get the latest message
                const latestMessage = messages[messages.length - 1];
                
                // Check if message already exists in the DOM
                const chatMessages = document.getElementById('chat-messages');
                if (!chatMessages) return;
                
                const existingMessage = chatMessages.querySelector(`[data-message-id="${latestMessage.id}"]`);
                if (existingMessage) return; // Already displayed
                
                // Create message element
                const messageEl = this.createChatMessageElement(latestMessage);
                chatMessages.appendChild(messageEl);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (e) {
                console.error('Failed to append chat message:', e);
            }
        },
        
        createChatMessageElement(msg) {
            const div = document.createElement('div');
            div.setAttribute('data-message-id', msg.id);
            div.className = 'p-4 rounded-2xl bg-gradient-to-br from-white to-pink-50 border-2 border-pink-200 shadow-soft hover:shadow-soft-lg transition-all duration-200';
            
            const timestamp = new Date(msg.ts).toLocaleTimeString();
            const typeLabel = msg.type === 'system' ? 'ü§ñ System' : 'üë§ User';
            const typeClass = msg.type === 'system' ? 'text-purple-700 font-bold font-display' : 'text-gray-800 font-semibold';
            
            div.innerHTML = `
                <div class="text-sm mb-2">
                    <span class="${typeClass}">${typeLabel}</span>
                    <span class="text-gray-500 text-xs ml-2">${timestamp}</span>
                </div>
                <div class="text-gray-800 font-display">${this.escapeHtml(msg.text)}</div>
            `;
            
            return div;
        },
        
        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        
        filterPlayers() {
            const players = document.querySelectorAll('#players-grid > div');
            let visibleCount = 0;
            
            players.forEach(player => {
                const playerCard = player;
                const name = playerCard.textContent.toLowerCase();
                const matchesSearch = this.search === '' || name.includes(this.search.toLowerCase());
                
                // Get position from the player card
                const positionEl = playerCard.querySelector('.px-2.py-1.rounded.text-xs.font-medium.border');
                const position = positionEl ? positionEl.textContent.trim() : '';
                const matchesPosition = this.filterPosition === '' || position === this.filterPosition;
                
                if (matchesSearch && matchesPosition) {
                    playerCard.style.display = '';
                    visibleCount++;
                } else {
                    playerCard.style.display = 'none';
                }
            });
            
            // Update counter
            const counter = document.getElementById('available-count');
            if (counter) {
                counter.textContent = visibleCount;
            }
        },
        
        showNotification(message, type = 'info') {
            this.notification = { message, type };
            setTimeout(() => {
                this.notification = null;
            }, 3000);
        },
        
        resetFilters() {
            this.search = '';
            this.filterPosition = '';
            this.filterTier = '';
            this.filterPlayers();
        }
    };
}
</script>

{{ end }}
